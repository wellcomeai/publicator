"""OpenAI —Å–µ—Ä–≤–∏—Å ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Ä–µ—Ä–∞–π—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ GPT-4o-mini"""

import structlog
from typing import Dict, Any, List, Optional
from openai import AsyncOpenAI
from config.settings import config

logger = structlog.get_logger()

client = AsyncOpenAI(api_key=config.OPENAI_API_KEY)


SYSTEM_PROMPT_BASE = """–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –º–∏—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–æ–≤. –ü–∏—à–µ—à—å –ø–æ—Å—Ç—ã, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–æ—Ä–≤–∞—Ç—å—Å—è.

‚ïê‚ïê‚ïê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï ‚ïê‚ïê‚ïê

–ò—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏ Telegram. –í –ö–ê–ñ–î–û–ú –ø–æ—Å—Ç–µ ‚Äî –º–∏–Ω–∏–º—É–º 3-4 —Ä–∞–∑–Ω—ã—Ö —Ç–µ–≥–∞:

‚Ä¢ <b>–∂–∏—Ä–Ω—ã–π</b> ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–ª—é—á–µ–≤—ã–µ –º—ã—Å–ª–∏, –∞–∫—Ü–µ–Ω—Ç—ã
‚Ä¢ <i>–∫—É—Ä—Å–∏–≤</i> ‚Äî —Ä–µ–º–∞—Ä–∫–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å, —É—Ç–æ—á–Ω–µ–Ω–∏—è
‚Ä¢ <code>–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π</code> ‚Äî —Ü–∏—Ñ—Ä—ã, —Ç–µ—Ä–º–∏–Ω—ã, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
‚Ä¢ <blockquote>—Ü–∏—Ç–∞—Ç–∞</blockquote> ‚Äî –∫–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å, –≤—ã–≤–æ–¥, —Ü–∏—Ç–∞—Ç–∞
‚Ä¢ <tg-spoiler>—Å–ø–æ–π–ª–µ—Ä</tg-spoiler> ‚Äî –∏–Ω—Ç—Ä–∏–≥–∞, —Å–∫—Ä—ã—Ç—ã–π –æ—Ç–≤–µ—Ç
‚Ä¢ <s>–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π</s> ‚Äî –∏—Ä–æ–Ω–∏—è, —Å–∞–º–æ–ø—Ä–∞–≤–∫–∞
‚Ä¢ <u>–ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π</u> ‚Äî –≤–∞–∂–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
‚Ä¢ <a href="URL">—Å—Å—ã–ª–∫–∞</a> ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å

–ó–ê–ü–†–ï–©–ï–ù–û: Markdown-—Ä–∞–∑–º–µ—Ç–∫–∞ (**, __, ```), —Ö–µ—à—Ç–µ–≥–∏ (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ).
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ —Å—Å—ã–ª–∫–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

‚ïê‚ïê‚ïê –°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê ‚ïê‚ïê‚ïê

1. –ö–†–Æ–ß–û–ö (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) ‚Äî —Ü–µ–ø–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è, —Ü–∏—Ñ—Ä–∞, –ø–∞—Ä–∞–¥–æ–∫—Å, –∏—Å—Ç–æ—Ä–∏—è, –≤–æ–ø—Ä–æ—Å.
2. –¢–ï–õ–û ‚Äî —Ü–µ–Ω–Ω–æ—Å—Ç—å, —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ —Ç–µ–º—ã. –ñ–∏–≤–æ–π —è–∑—ã–∫, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, –ø—Ä–∏–º–µ—Ä—ã.
3. –§–ò–ù–ê–õ ‚Äî CTA, –º—ã—Å–ª—å –¥–ª—è –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è, –≤–æ–ø—Ä–æ—Å –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏.

‚ïê‚ïê‚ïê –°–¢–ò–õ–ò–°–¢–ò–ö–ê ‚ïê‚ïê‚ïê

‚úÖ –î–ï–õ–ê–ô:
- –ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫, –∫–∞–∫ –±—É–¥—Ç–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –¥—Ä—É–≥—É
- –ú–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∏—Å—É—é—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –≤–º–µ—Å—Ç–æ ¬´–º–Ω–æ–≥–æ¬ª, ¬´—á–∞—Å—Ç–æ¬ª, ¬´–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ¬ª
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–µ –∑–∞—Ö–æ–¥—ã
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –≠–º–æ—Ü–∏–∏ –∏ —ç–Ω–µ—Ä–≥–∏—è –≤ –∫–∞–∂–¥–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏

üö´ –ó–ê–ü–†–ï–©–ï–ù–û:
- –ö–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç: ¬´–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è¬ª, ¬´–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å¬ª, ¬´—è–≤–ª—è–µ—Ç—Å—è¬ª
- –ö–ª–∏—à–µ: ¬´–≤ –º–∏—Ä–µ...¬ª, ¬´—Å–µ–≥–æ–¥–Ω—è –º—ã...¬ª, ¬´–Ω–µ —Å–µ–∫—Ä–µ—Ç —á—Ç–æ...¬ª, ¬´–¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è¬ª
- –®–∞–±–ª–æ–Ω–Ω—ã–µ –Ω–∞—á–∞–ª–∞: ¬´–î—Ä—É–∑—å—è!¬ª, ¬´–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!¬ª, ¬´–ê –≤—ã –∑–Ω–∞–ª–∏?¬ª (–∑–∞–µ–∑–∂–µ–Ω–æ)
- –í–æ–¥—è–Ω–∏—Å—Ç—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–æ–¥—Ä—è–¥ ‚Äî —á–µ—Ä–µ–¥—É–π —Ñ–æ—Ä–º–∞—Ç—ã!

‚ïê‚ïê‚ïê –ß–ï–†–ï–î–û–í–ê–ù–ò–ï –§–û–†–ú–ê–¢–û–í ‚ïê‚ïê‚ïê

–ö–∞–∂–¥—ã–π –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ. –ß–µ—Ä–µ–¥—É–π:
‚Äî –ò—Å—Ç–æ—Ä–∏—è/–∫–µ–π—Å ‚Üí –°–ø–∏—Å–æ–∫/–ø–æ–¥–±–æ—Ä–∫–∞ ‚Üí –ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è/–º–Ω–µ–Ω–∏–µ ‚Üí –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è/–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å ‚Üí –¶–∏—Ç–∞—Ç–∞-—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ

‚ïê‚ïê‚ïê –ü–†–ò–ú–ï–†–´ –ü–û–°–¢–û–í (–æ–±—Ä–∞–∑–µ—Ü –∫–∞—á–µ—Å—Ç–≤–∞) ‚ïê‚ïê‚ïê

–ü–†–ò–ú–ï–† 1 (–∏—Å—Ç–æ—Ä–∏—è + —Ü–∏—Ç–∞—Ç–∞):
<b>–û–Ω –ø–æ—Ç–µ—Ä—è–ª $2 –º–ª–Ω –∑–∞ –æ–¥–Ω—É –Ω–æ—á—å</b>

–ò –Ω–µ—Ç, —ç—Ç–æ –Ω–µ –∫—Ä–∏–ø—Ç–∞. –û–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞ ‚Äî –∏ –±–∏–∑–Ω–µ—Å, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç—Ä–æ–∏–ª—Å—è <code>4 –≥–æ–¥–∞</code>, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–ª —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.

<i>–°–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ ‚Äî –æ–Ω –∑–Ω–∞–ª, —á—Ç–æ —ç—Ç–æ —Å–ª—É—á–∏—Ç—Å—è. –ó–∞ –ø–æ–ª–≥–æ–¥–∞ –¥–æ.</i>

–ù–æ –Ω–µ —Å–¥–µ–ª–∞–ª –Ω–∏—á–µ–≥–æ. –ü–æ—Ç–æ–º—É —á—Ç–æ ¬´–Ω—É –∞–≤–æ—Å—å –ø—Ä–æ–Ω–µ—Å—ë—Ç¬ª.

<blockquote>–ê–≤–æ—Å—å ‚Äî —Å–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω –≤ –º–∏—Ä–µ</blockquote>

–£ —Ç–µ–±—è –µ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å? –°–µ–≥–æ–¥–Ω—è ‚Äî —Ç–æ—Ç –¥–µ–Ω—å.

–ü–†–ò–ú–ï–† 2 (—Å–ø–∏—Å–æ–∫ + —Å–ø–æ–π–ª–µ—Ä):
<b>3 –Ω–∞–≤—ã–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ–∫—É–ø—è—Ç—Å—è –≤ 10 —Ä–∞–∑</b>

–ó–∞–±—É–¥—å –ø—Ä–æ ¬´–∂—ë—Å—Ç–∫–∏–µ¬ª –∏ ¬´–º—è–≥–∫–∏–µ¬ª. –í–æ—Ç —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ—Ç –∫–∞—Ä—å–µ—Ä—É:

<code>1.</code> –£–º–µ–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–Ω–µ—Ç¬ª ‚Äî <s>–≤–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∑—ã–≤–∞—Ç—å</s> –∑–∞—â–∏—â–∞—Ç—å —Å–≤–æ—ë –≤—Ä–µ–º—è
<code>2.</code> –ü–∏—Å–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã –¥–æ—á–∏—Ç–∞–ª–∏ ‚Äî <i>80% –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã</i>
<code>3.</code> <tg-spoiler>–ü—Ä–æ–¥–∞–≤–∞—Ç—å, –Ω–µ –ø—Ä–æ–¥–∞–≤–∞—è</tg-spoiler> ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –Ω–∞–∑–≤–∞–ª —Ü–µ–Ω—É

–ö–∞–∫–æ–π –∏–∑ –Ω–∏—Ö —É —Ç–µ–±—è —É–∂–µ –ø—Ä–æ–∫–∞—á–∞–Ω?

–ü–†–ò–ú–ï–† 3 (–ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è):
<s>–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –Ω–µ –Ω—É–∂–µ–Ω</s>

<b>–ù—É–∂–Ω–∞ —Å–∏—Å—Ç–µ–º–∞, –∞ –Ω–µ —Ç–∞–±–ª–∏—á–∫–∞ —Å –¥–∞—Ç–∞–º–∏</b>

–ó–Ω–∞–µ—à—å —Ä–∞–∑–Ω–∏—Ü—É? –¢–∞–±–ª–∏—á–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç <i>¬´–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –ø–æ—Å—Ç –ø—Ä–æ –º–æ—Ç–∏–≤–∞—Ü–∏—é¬ª</i>. –°–∏—Å—Ç–µ–º–∞ –≥–æ–≤–æ—Ä–∏—Ç:

<blockquote>–¢–≤–æ—è –∞—É–¥–∏—Ç–æ—Ä–∏—è —É—Å—Ç–∞–ª–∞ –æ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏. –î–∞–π –∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π. –° —Ü–∏—Ñ—Ä–∞–º–∏.</blockquote>

<code>90%</code> –∫–∞–Ω–∞–ª–æ–≤ —É–º–∏—Ä–∞—é—Ç –Ω–µ –∏–∑-–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ê –∏–∑-–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø–∏—Å–∞–Ω ¬´–¥–ª—è –≥–∞–ª–æ—á–∫–∏¬ª.

‚ïê‚ïê‚ïê –õ–ò–ú–ò–¢–´ ‚ïê‚ïê‚ïê

–ú–∞–∫—Å–∏–º—É–º 900 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –ø–æ—Å—Ç (—Å —É—á—ë—Ç–æ–º HTML-—Ç–µ–≥–æ–≤).
–ü–∏—à–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ, –Ω–æ –º–æ—â–Ω–æ. –ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ ‚Äî –Ω–∞ –≤–µ—Å –∑–æ–ª–æ—Ç–∞."""


async def generate_content(
    user_prompt: str,
    agent_instructions: str,
    conversation_history: List[Dict[str, str]] = None,
    model: str = None
) -> Dict[str, Any]:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
    
    conversation_history: —Å–ø–∏—Å–æ–∫ {"role": "user"/"assistant", "content": "..."}
    –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    model = model or config.OPENAI_MODEL

    system_message = f"{SYSTEM_PROMPT_BASE}\n\n–ò–ù–°–¢–†–£–ö–¶–ò–ò –ê–í–¢–û–†–ê –ö–ê–ù–ê–õ–ê:\n{agent_instructions}"

    messages = [{"role": "system", "content": system_message}]

    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    if conversation_history:
        messages.extend(conversation_history)

    messages.append({"role": "user", "content": user_prompt})

    try:
        response = await client.chat.completions.create(
            model=model,
            messages=messages,
            max_tokens=2000,
            temperature=0.7,
        )

        choice = response.choices[0]
        generated_text = choice.message.content.strip()

        usage = response.usage
        input_tokens = usage.prompt_tokens if usage else 0
        output_tokens = usage.completion_tokens if usage else 0

        logger.info("‚úÖ Content generated",
                     model=model,
                     input_tokens=input_tokens,
                     output_tokens=output_tokens,
                     output_length=len(generated_text))

        return {
            "success": True,
            "text": generated_text,
            "input_tokens": input_tokens,
            "output_tokens": output_tokens,
            "total_tokens": input_tokens + output_tokens,
            "model": model,
        }

    except Exception as e:
        logger.error("‚ùå OpenAI generation failed", error=str(e))
        return {
            "success": False,
            "error": str(e),
            "text": "",
            "input_tokens": 0,
            "output_tokens": 0,
            "total_tokens": 0,
        }


CONFIRM_PLAN_TOOL = {
    "type": "function",
    "function": {
        "name": "confirm_content_plan",
        "description": (
            "–í—ã–∑–æ–≤–∏ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ø–í–ù–û –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω. "
            "–ù–µ –≤—ã–∑—ã–≤–∞–π –±–µ–∑ —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è (—Å–ª–æ–≤–∞: –¥–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, –æ–∫, –ø–æ–≥–Ω–∞–ª–∏, –∑–∞–ø—É—Å–∫–∞–π, –≤—Å—ë –≤–µ—Ä–Ω–æ)."
        ),
        "parameters": {
            "type": "object",
            "properties": {
                "topics": {
                    "type": "array",
                    "description": "–ú–∞—Å—Å–∏–≤ —Ç–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏",
                    "items": {
                        "type": "object",
                        "properties": {
                            "topic": {
                                "type": "string",
                                "description": "–¢–µ–º–∞ –ø–æ—Å—Ç–∞"
                            },
                            "format": {
                                "type": "string",
                                "enum": ["–ø–æ—Å—Ç", "–ª–æ–Ω–≥—Ä–∏–¥", "—Å–ø–∏—Å–æ–∫", "–∏—Å—Ç–æ—Ä–∏—è", "–∫–µ–π—Å", "–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "–æ–±–∑–æ—Ä"],
                                "description": "–§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
                            },
                            "description": {
                                "type": "string",
                                "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –æ —á—ë–º –∏–º–µ–Ω–Ω–æ –ø–æ—Å—Ç (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"
                            }
                        },
                        "required": ["topic", "format", "description"]
                    }
                }
            },
            "required": ["topics"]
        }
    }
}


def build_plan_system_prompt(
    agent_instructions: str,
    channel_name: str,
    slots_count: int,
    schedule_info: str,
    current_date: str = "",
    user_topics: str = ""
) -> str:
    """
    –°—Ç—Ä–æ–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—É.

    Args:
        agent_instructions: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–Ω, —Å—Ç–∏–ª—å, —Ç–µ–º–∞—Ç–∏–∫–∞)
        channel_name: –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
        slots_count: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ (—Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ –Ω—É–∂–Ω–æ)
        schedule_info: —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ("–ü–Ω 10:00, –°—Ä 14:00, –ü—Ç 18:00")
        current_date: —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–¥–¥.–º–º.–≥–≥–≥–≥ (–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏)"
        user_topics: —Ç–µ–º—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
    """
    user_topics_block = ""
    if user_topics:
        user_topics_block = f"""
<user_topics>
–í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Å–≤–µ—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ–º—ã:
{user_topics}

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏ —ç—Ç–∏ —Ç–µ–º—ã –≤ –ø–ª–∞–Ω. –î–æ–ø–æ–ª–Ω–∏ –ø–ª–∞–Ω —Å–≤–æ–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ {slots_count} —Å–ª–æ—Ç–æ–≤ –Ω–∞ 7 –¥–Ω–µ–π. –¢–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.
</user_topics>
"""

    return f"""<role>
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-—Å—Ç—Ä–∞—Ç–µ–≥ –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä Telegram-–∫–∞–Ω–∞–ª–∞ "{channel_name}".
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –Ω–∞ <b>7 –¥–Ω–µ–π</b>: –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–º—ã, –æ–±—Å—É–¥–∏—Ç—å –∏—Ö, –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫.
</role>

<current_context>
–°–µ–≥–æ–¥–Ω—è: {current_date}
–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {schedule_info}
–í—Å–µ–≥–æ —Å–ª–æ—Ç–æ–≤ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏: {slots_count}
–ü–ª–∞–Ω —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ 7 –¥–Ω–µ–π.
</current_context>

<channel_identity>
{agent_instructions}
</channel_identity>
{user_topics_block}
<workflow>
1. –ü–†–ï–î–õ–û–ñ–ò —Ç–µ–º—ã –¥–ª—è –ø–æ—Å—Ç–æ–≤, —É—á–∏—Ç—ã–≤–∞—è —Ç–µ–º–∞—Ç–∏–∫—É –∫–∞–Ω–∞–ª–∞ –∏ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
2. –û–ë–°–£–î–ò —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Äî –æ–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ç–µ–º—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–æ—Ä—è–¥–æ–∫, —Ñ–æ—Ä–º–∞—Ç—ã
3. –ü–û–î–¢–í–ï–†–î–ò –ø–ª–∞–Ω –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨, –∞ –Ω–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "2 –ø–æ—Å—Ç–∞" ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–æ–≤–Ω–æ 2 —Ç–µ–º—ã
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "5 –ø–æ—Å—Ç–æ–≤" ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–æ–≤–Ω–æ 5 —Ç–µ–º
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É–∫–∞–∑–∞–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ {slots_count} —Ç–µ–º (–ø–æ —á–∏—Å–ª—É —Å–ª–æ—Ç–æ–≤ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏) –∏ —Å–ø—Ä–æ—Å–∏, —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- –ü–æ—Å—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –±–ª–∏–∂–∞–π—à–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–º —Å–ª–æ—Ç–∞–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
</workflow>

<topic_quality>
–ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π (–Ω–µ "—á—Ç–æ-—Ç–æ –ø—Ä–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥", –∞ "5 –æ—à–∏–±–æ–∫ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–∏–≤–∞—é—Ç –±—é–¥–∂–µ—Ç")
- –ê–∫—Ç—É–∞–ª—å–Ω–æ–π (—É—á–∏—Ç—ã–≤–∞–π —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É, —Å–µ–∑–æ–Ω, —Ç—Ä–µ–Ω–¥—ã)
- –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –ø–æ —Ñ–æ—Ä–º–∞—Ç—É (—á–µ—Ä–µ–¥—É–π: –ø–æ—Å—Ç, —Å–ø–∏—Å–æ–∫, –∫–µ–π—Å, –∏—Å—Ç–æ—Ä–∏—è, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –æ–±–∑–æ—Ä, –ª–æ–Ω–≥—Ä–∏–¥)
- –¶–µ–Ω–Ω–æ–π –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å, –∏–Ω—Å–∞–π—Ç –∏–ª–∏ —ç–º–æ—Ü–∏—è)
</topic_quality>

<confirmation_rules>
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–∑–æ–≤–∞ confirm_content_plan:
- –í—ã–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –Ø–í–ù–û–ì–û –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: "–¥–∞", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", "–æ–∫", "–∑–∞–ø—É—Å–∫–∞–π", "–≤—Å—ë –≤–µ—Ä–Ω–æ", "–ø–æ–≥–Ω–∞–ª–∏", "–≥–æ", "–¥–∞–≤–∞–π"
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–∑—ã–≤–∞–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—Å—É–∂–¥–∞–µ—Ç, —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è, –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
- "–•–æ—Ä–æ—à–æ" –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è ‚Äî –ù–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —É—Ç–æ—á–Ω–∏: "–ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —ç—Ç–∏—Ö N –ø–æ—Å—Ç–æ–≤?"
- –í confirm_content_plan –ø–µ—Ä–µ–¥–∞–≤–∞–π –†–û–í–ù–û —Å—Ç–æ–ª—å–∫–æ —Ç–µ–º, —Å–∫–æ–ª—å–∫–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –Ω–∏ –±–æ–ª—å—à–µ, –Ω–∏ –º–µ–Ω—å—à–µ
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ–¥–µ—Ä–∂–∏—Ç: topic (—Ç–µ–º–∞), format (—Ñ–æ—Ä–º–∞—Ç), description (–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
</confirmation_rules>

<response_format>
–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –≤ Telegram. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã —Å HTML-—Ç–µ–≥–∞–º–∏:
- <b>–∂–∏—Ä–Ω—ã–π</b> –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑
- <i>–∫—É—Ä—Å–∏–≤</i> –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ —Ä–µ–º–∞—Ä–æ–∫
- <code>–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π</code> –¥–ª—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤

–ö–∞–∂–¥—É—é —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª—è–π –Ω–∞–≥–ª—è–¥–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä:

<code>1.</code> <b>–¢–µ–º–∞ –ø–æ—Å—Ç–∞</b>
<i>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É–≥–ª–∞ –ø–æ–¥–∞—á–∏</i>

<code>2.</code> <b>–¢–µ–º–∞ –ø–æ—Å—Ç–∞</b>
<i>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É–≥–ª–∞ –ø–æ–¥–∞—á–∏</i>

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π plain text —Å–ø–∏—Å–∫–∏. –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ.
–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º. –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –æ—Ç–≤–µ—Ç. –û–±—â–∞–π—Å—è –ø–æ-—Ä—É—Å—Å–∫–∏.
</response_format>"""


async def rewrite_post(
    original_text: str,
    agent_instructions: str,
    links_info: str = "",
    model: str = None
) -> Dict[str, Any]:
    """–†–µ—Ä–∞–π—Ç –ø–æ—Å—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Å—ã–ª–æ–∫"""

    prompt = (
        "–ü–µ—Ä–µ–ø–∏—à–∏ —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞.\n"
        "–í–ê–ñ–ù–û: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –¥–æ 900 —Å–∏–º–≤–æ–ª–æ–≤ –≤–∫–ª—é—á–∞—è HTML-—Ç–µ–≥–∏ –∏ –ø—Ä–æ–±–µ–ª—ã.\n"
        "–ü—Ä–∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏ Telegram: <b>, <i>, <code>, <blockquote>, <tg-spoiler>, <s>, <u>.\n"
        "–ú–∏–Ω–∏–º—É–º 3-4 —Ä–∞–∑–Ω—ã—Ö —Ç–µ–≥–∞. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∫—Ä—é—á–æ–∫ ‚Üí —Ü–µ–Ω–Ω–æ—Å—Ç—å ‚Üí —Ñ–∏–Ω–∞–ª. –ñ–∏–≤–æ–π —è–∑—ã–∫, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞ –∏ –∫–ª–∏—à–µ.\n"
        "–°–æ—Ö—Ä–∞–Ω–∏ —Ç–µ–º—É, –Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π –ø–æ–¥–∞—á—É –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–æ–ø-–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä–∞.\n\n"
        f"–û—Ä–∏–≥–∏–Ω–∞–ª:\n{original_text}"
    )

    if links_info:
        prompt += f"\n\n–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–∏ —Å—Å—ã–ª–∫–∏:\n{links_info}"

    return await generate_content(
        user_prompt=prompt,
        agent_instructions=agent_instructions,
        model=model
    )


async def edit_content(
    current_text: str,
    edit_instruction: str,
    agent_instructions: str,
    conversation_history: List[Dict[str, str]] = None,
    model: str = None
) -> Dict[str, Any]:
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""

    # –°—Ç—Ä–æ–∏–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    history = conversation_history or []

    prompt = (
        f"–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞:\n\n{current_text}\n\n"
        f"–ó–∞–¥–∞—á–∞: {edit_instruction}\n\n"
        f"–í–ê–ñ–ù–û: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –¥–æ 900 —Å–∏–º–≤–æ–ª–æ–≤ –≤–∫–ª—é—á–∞—è HTML-—Ç–µ–≥–∏ –∏ –ø—Ä–æ–±–µ–ª—ã. "
        f"–ù–µ –ø—Ä–µ–≤—ã—à–∞–π —ç—Ç–æ—Ç –ª–∏–º–∏—Ç.\n"
        f"–†–µ–¥–∞–∫—Ç–∏—Ä—É–π –ø–æ—Å—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º HTML-—Ç–µ–≥–æ–≤ Telegram: <b>, <i>, <code>, <blockquote>, <tg-spoiler>, <s>, <u>.\n"
        f"–ú–∏–Ω–∏–º—É–º 3-4 —Ä–∞–∑–Ω—ã—Ö —Ç–µ–≥–∞. –°–æ—Ö—Ä–∞–Ω—è–π –∂–∏–≤–æ–π —Å—Ç–∏–ª—å, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É, —ç–º–æ—Ü–∏–∏. –ù–∏–∫–∞–∫–æ–≥–æ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞."
    )

    return await generate_content(
        user_prompt=prompt,
        agent_instructions=agent_instructions,
        conversation_history=history,
        model=model
    )
